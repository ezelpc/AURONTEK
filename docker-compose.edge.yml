version: "3.9"

services:
  redis:
    image: redis:7-alpine
    command: redis-server --maxmemory 50mb --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    mem_limit: 50m
    restart: always
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 3s
      retries: 3

  gateway:
    image: ${DOCKER_USERNAME}/aurontek-gateway:${IMAGE_TAG:-latest}
    container_name: gateway-svc
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: production
      PORT: 3000
      REDIS_URL: redis://redis:6379
      USUARIOS_SERVICE_URL: http://${CORE_PRIVATE_IP}:3001
      TICKETS_SERVICE_URL: http://${CORE_PRIVATE_IP}:3002
      CHAT_SERVICE_URL: http://${CORE_PRIVATE_IP}:3003
      NOTIFICACIONES_SERVICE_URL: http://${CORE_PRIVATE_IP}:3004
      IA_SERVICE_URL: http://${CORE_PRIVATE_IP}:3005
      FRONTEND_URL: ${FRONTEND_URL}
      CUSTOM_DOMAIN: ${CUSTOM_DOMAIN:-}
      JWT_SECRET: ${JWT_SECRET}
      SERVICE_TOKEN: ${SERVICE_TOKEN}
      RECAPTCHA_SECRET_KEY: ${RECAPTCHA_SECRET_KEY}
      RECAPTCHA_TEST_TOKEN: ${RECAPTCHA_TEST_TOKEN:-}
      NODE_OPTIONS: "--max-old-space-size=220"
    depends_on:
      - redis
    mem_limit: 220m
    restart: always
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
