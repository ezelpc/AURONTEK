# ‚úÖ CHECKLIST - Implementaci√≥n de Correcciones de Notificaciones\n\n## üìã Pre-Implementaci√≥n\n\n- [ ] Leer `RESUMEN_CORRECCION_NOTIFICACIONES.md`\n- [ ] Revisar `ARQUITECTURA_NOTIFICACIONES.md`\n- [ ] Entender el cambio principal: prefijo de rutas\n- [ ] Backup de c√≥digo actual (git)\n\n```bash\ncd backend/notificaciones-svc\ngit status\ngit add -A && git commit -m 'Backup antes de correciones'\n```\n\n---\n\n## üîß Implementaci√≥n de Cambios\n\n### 1. Verificar archivo index.ts\n\n- [ ] Abrir `backend/notificaciones-svc/src/index.ts`\n- [ ] Ir a l√≠nea 62\n- [ ] Verificar que dice: `app.use('/api/notificaciones', notificationRoutes);`\n- [ ] Si dice `app.use('/', notificationRoutes);` ‚Üí Necesita correcci√≥n ‚ùå\n\n**Correcci√≥n:**\n```bash\n# El archivo ya deber√≠a tener el cambio aplicado\n# Pero si no, cambiar la l√≠nea 62 de:\napp.use('/', notificationRoutes);\n# A:\napp.use('/api/notificaciones', notificationRoutes);\n```\n\n- [ ] Guardar archivo (Ctrl+S)\n\n### 2. Verificar archivo notificacion.routes.ts\n\n- [ ] Abrir `backend/notificaciones-svc/src/Routes/notificacion.routes.ts`\n- [ ] Verificar que el orden es:\n  - [ ] GET /\n  - [ ] PATCH /leer-todas (DEBE estar antes de /:id)\n  - [ ] PATCH /:id/leer\n  - [ ] POST /system-email\n  - [ ] DELETE /:id\n  - [ ] DELETE /\n  - [ ] GET /no-leidas/count\n\n**Si el orden es incorrecto:**\n- [ ] Reordenar las rutas como se muestra arriba\n- [ ] Guardar archivo\n\n### 3. Verificar archivo notificacion.controller.ts\n\n- [ ] Abrir `backend/notificaciones-svc/src/Controllers/notificacion.controller.ts`\n- [ ] Verificar que tiene los imports correctos (l√≠nea 3):\n  - [ ] `import { sendEmail } from '../Services/email.service';`\n- [ ] Verificar funci√≥n `verificarTokenServicio` (debe existir despu√©s de `getUserIdFromToken`)\n- [ ] Verificar que el controller tiene estos m√©todos:\n  - [ ] `listar`\n  - [ ] `marcarLeida`\n  - [ ] `marcarTodasLeidas`\n  - [ ] `eliminar`\n  - [ ] `eliminarTodas` ‚ú® (nuevo)\n  - [ ] `contarNoLeidas`\n  - [ ] `enviarEmailSistema` ‚ú® (nuevo)\n  - [ ] `obtenerPreferencias`\n  - [ ] `actualizarPreferencias`\n\n**Si faltan m√©todos:**\n- [ ] Copiar del documento `CORRECCION_NOTIFICACIONES_SVC.md`\n- [ ] Guardar archivo\n\n### 4. Verificar archivo email.service.ts\n\n- [ ] Abrir `backend/notificaciones-svc/src/Services/email.service.ts`\n- [ ] Verificar interface EmailOptions (l√≠nea 5):\n  - [ ] `to: string`\n  - [ ] `subject: string`\n  - [ ] `html?: string` (opcional)\n  - [ ] `text?: string` (opcional)\n- [ ] Verificar funci√≥n sendEmail acepta ambos par√°metros\n\n**Si no est√° actualizado:**\n- [ ] Actualizar interface y funci√≥n\n- [ ] Guardar archivo\n\n---\n\n## üß™ Validaci√≥n de Cambios\n\n### Compilaci√≥n\n\n- [ ] Abrir terminal en `backend/notificaciones-svc`\n- [ ] Ejecutar: `npm run build`\n- [ ] ‚úÖ No debe haber errores de TypeScript\n- [ ] Si hay errores ‚Üí Revisar tipos en archivos modificados\n\n```bash\ncd backend/notificaciones-svc\nnpm run build\n# Esperado: \"Successfully compiled\"\n```\n\n### Iniciar Servicio\n\n- [ ] Ejecutar: `npm run dev`\n- [ ] Ver en logs:\n  ```\n  ‚úÖ Notificaciones-SVC conectado a MongoDB\n  ‚úÖ Notificaciones-SVC escuchando en el puerto 3004\n  üìß Resend API configurado\n  üê∞ RabbitMQ: amqp://...\n  ```\n- [ ] Si hay errores:\n  - [ ] Verificar MongoDB est√° corriendo\n  - [ ] Verificar puertos disponibles\n  - [ ] Revisar logs de error\n\n### Test Health Check\n\n- [ ] Abrir nueva terminal\n- [ ] Ejecutar:\n  ```bash\n  curl -X GET http://localhost:3004/health\n  ```\n- [ ] Deber√≠a retornar:\n  ```json\n  {\n    \"status\": \"OK\",\n    \"service\": \"notificaciones-svc\",\n    \"timestamp\": \"2025-01-11T10:30:45.123Z\"\n  }\n  ```\n\n---\n\n## üì± Pruebas de Endpoints\n\n### Test 1: Gateway est√° funcionando\n\n- [ ] Verificar que gateway est√° corriendo en puerto 3000\n- [ ] Ejecutar:\n  ```bash\n  curl http://localhost:3000/health\n  ```\n- [ ] Deber√≠a retornar algo (no es 404)\n\n### Test 2: Obtener token v√°lido\n\n- [ ] Iniciar sesi√≥n en el frontend (http://localhost:5173)\n- [ ] Abrir DevTools (F12)\n- [ ] Ir a Console y ejecutar:\n  ```javascript\n  localStorage.getItem('token')\n  ```\n- [ ] Copiar el token (empieza con eyJ...)\n\n### Test 3: GET /api/notificaciones\n\n- [ ] Reemplazar TOKEN con el token obtenido\n- [ ] Ejecutar:\n  ```bash\n  TOKEN=\"eyJ...\" \n  curl -X GET http://localhost:3000/api/notificaciones \\\n    -H \"Authorization: Bearer $TOKEN\" \\\n    -v\n  ```\n- [ ] ‚úÖ Esperado: HTTP 200\n- [ ] ‚úÖ Body: Array JSON (vac√≠o o con notificaciones)\n- [ ] ‚ùå Error 404: Revisar `index.ts` l√≠nea 62\n- [ ] ‚ùå Error 401: Token expirado, obtener nuevo\n\n### Test 4: POST /api/notificaciones/system-email\n\n- [ ] Ejecutar (sin token):\n  ```bash\n  curl -X POST http://localhost:3000/api/notificaciones/system-email \\\n    -H \"Content-Type: application/json\" \\\n    -d '{\n      \"to\": \"tu_email@example.com\",\n      \"subject\": \"Test Email\",\n      \"html\": \"<h1>Test</h1>\",\n      \"serviceToken\": \"desarrollo\"\n    }' \\\n    -v\n  ```\n- [ ] ‚úÖ Esperado: HTTP 200\n- [ ] ‚úÖ Body: `{ msg: \"Email enviado exitosamente\", ... }`\n- [ ] ‚ùå Error 404: Verificar que la ruta est√° en `notificacion.routes.ts`\n- [ ] ‚ùå Error 500: Verificar `RESEND_API_KEY` en `.env`\n\n### Test 5: PATCH /api/notificaciones/leer-todas\n\n- [ ] Ejecutar:\n  ```bash\n  TOKEN=\"eyJ...\"\n  curl -X PATCH http://localhost:3000/api/notificaciones/leer-todas \\\n    -H \"Authorization: Bearer $TOKEN\" \\\n    -H \"Content-Type: application/json\" \\\n    -v\n  ```\n- [ ] ‚úÖ Esperado: HTTP 200\n- [ ] ‚úÖ Body: `{ msg: \"Todas marcadas como le√≠das\" }`\n- [ ] ‚ùå Error 404: Verificar orden de rutas (leer-todas debe estar ANTES de /:id)\n\n---\n\n## üé® Pruebas del Frontend\n\n### Frontend - Notifications Menu\n\n- [ ] Abrir frontend: http://localhost:5173\n- [ ] Iniciar sesi√≥n como usuario\n- [ ] Buscar el icono de campana (üîî) en la parte superior derecha\n- [ ] Hacer clic en el icono\n\n**Resultados esperados:**\n- [ ] Abre un dropdown con notificaciones\n- [ ] Si est√° vac√≠o: Est√° bien (nuevo usuario)\n- [ ] Si hay notificaciones: Se muestran correctamente\n- [ ] El contador muestra cantidad correcta\n- [ ] Los botones (leer, eliminar, limpiar) responden\n\n**Si hay errores:**\n- [ ] Abrir DevTools (F12) ‚Üí Console\n- [ ] Buscar error rojo con 404\n- [ ] Si dice `GET /api/notificaciones 404`: Problema en `index.ts`\n- [ ] Si dice `GET /api/notificaciones 401`: Token expirado\n\n### Acciones a Probar en el Menu\n\n- [ ] Hacer clic en una notificaci√≥n ‚Üí Deber√≠a marcarse como le√≠da\n- [ ] Bot√≥n \"Marcar todos como le√≠do\" ‚Üí Todas se marcan\n- [ ] Bot√≥n de eliminar (papelera) en una notificaci√≥n ‚Üí Se elimina\n- [ ] Bot√≥n \"Limpiar todas\" ‚Üí Se eliminan todas\n- [ ] Actualizar p√°gina (F5) ‚Üí Notificaciones se cargan nuevamente\n\n---\n\n## üìä Integraci√≥n con Otros Servicios\n\n### Test: Env√≠o de Email de Bienvenida (usuarios-svc)\n\n- [ ] Crear un nuevo usuario (en la API o frontend)\n- [ ] Ejecutar:\n  ```bash\n  curl -X POST http://localhost:3001/api/usuarios \\\n    -H \"Content-Type: application/json\" \\\n    -d '{\n      \"nombre\": \"Test User\",\n      \"correo\": \"testuser@example.com\",\n      \"password\": \"SecurePass123!\",\n      \"empresaId\": \"empresa_id\"\n    }'\n  ```\n- [ ] Revisar logs de notificaciones-svc\n- [ ] Ver que dice: `üìß Correo enviado a testuser@example.com`\n- [ ] Revisar email del usuario\n- [ ] Deber√≠a recibir email de bienvenida en m√°ximo 1 minuto\n\n### Test: Notificaci√≥n de Ticket Creado (tickets-svc)\n\n- [ ] Crear un nuevo ticket en la API o frontend\n- [ ] Revisar logs de notificaciones-svc\n- [ ] Ver que se guard√≥ notificaci√≥n en BD\n- [ ] Ir al frontend y revisar men√∫ de notificaciones\n- [ ] Deber√≠a aparecer la notificaci√≥n\n\n---\n\n## üîç Debugging\n\n### Si GET /api/notificaciones retorna 404\n\n**Checklist:**\n- [ ] Verificar `backend/notificaciones-svc/src/index.ts` l√≠nea 62\n- [ ] Debe decir: `app.use('/api/notificaciones', notificationRoutes);`\n- [ ] Reiniciar servicio: Ctrl+C en terminal y `npm run dev` de nuevo\n- [ ] Esperar a ver logs: `‚úÖ Notificaciones-SVC escuchando en el puerto 3004`\n- [ ] Probar nuevamente con curl\n\n### Si PATCH /leer-todas retorna 404\n\n**Checklist:**\n- [ ] Verificar orden en `notificacion.routes.ts`\n- [ ] `router.patch('/leer-todas', ...)` debe estar ANTES de `router.patch('/:id/leer', ...)`\n- [ ] Reiniciar servicio\n- [ ] Probar nuevamente\n\n### Si POST /system-email retorna 404\n\n**Checklist:**\n- [ ] Verificar que existe en `notificacion.routes.ts`\n- [ ] Debe tener: `router.post('/system-email', notificacionController.enviarEmailSistema);`\n- [ ] Verificar que existe funci√≥n `enviarEmailSistema` en `notificacion.controller.ts`\n- [ ] Reiniciar servicio\n- [ ] Probar nuevamente\n\n### Si Email no se env√≠a\n\n**Checklist:**\n- [ ] Verificar `.env` tiene `RESEND_API_KEY` v√°lido\n- [ ] Verificar `.env` tiene `RESEND_FROM_EMAIL` v√°lido\n- [ ] Revisar logs: debe mostrar `üìß Correo enviado a ...`\n- [ ] Si no sale log ‚Üí Error en el endpoint\n- [ ] Si sale error ‚Üí Problema con Resend API\n\n---\n\n## üìù Documentaci√≥n a Consultar\n\n| Documento | Cu√°ndo Consultar |\n|-----------|------------------|\n| `RESUMEN_CORRECCION_NOTIFICACIONES.md` | Resumen ejecutivo de cambios |\n| `CORRECCION_NOTIFICACIONES_SVC.md` | Detalle t√©cnico de cada cambio |\n| `ENDPOINTS_NOTIFICACIONES.md` | Referencia de API y ejemplos |\n| `PRUEBAS_NOTIFICACIONES.md` | Tests paso a paso |\n| `ARQUITECTURA_NOTIFICACIONES.md` | Diagramas y flujos |\n\n---\n\n## ‚ú® Finalizaci√≥n\n\n- [ ] Todos los tests pasaron\n- [ ] Frontend muestra notificaciones correctamente\n- [ ] Emails se env√≠an sin errores\n- [ ] No hay errores 404 en DevTools\n- [ ] Logs muestran mensajes de √©xito ‚úÖ\n\n**Si todo pas√≥:**\n- [ ] Hacer commit:\n  ```bash\n  git add -A\n  git commit -m \"Correcci√≥n: Servicio de notificaciones funcionando\"\n  git push\n  ```\n\n**Si hay problemas:**\n- [ ] Revisar section \"Debugging\" arriba\n- [ ] Consultar documentaci√≥n de error espec√≠fica\n- [ ] Aumentar verbosity de logs en c√≥digo\n- [ ] Verificar puertos no est√°n en conflicto\n\n---\n\n## üìû Resumen de Cambios Realizados\n\n```bash\n# Archivo 1: index.ts\nCambio: L√≠nea 62\nAntes:  app.use('/', notificationRoutes);\nAhora:  app.use('/api/notificaciones', notificationRoutes);\n\n# Archivo 2: notificacion.routes.ts  \nCambio: Reordenar rutas + agregar nuevas\nAntes:  router.get('/');\n        router.patch('/:id/leer');      ‚Üê Atrapaba /leer-todas ‚ùå\n        router.patch('/leer-todas');   ‚Üê Nunca se ejecutaba ‚ùå\nAhora:  router.get('/');\n        router.patch('/leer-todas');   ‚Üê Ahora se ejecuta ‚úÖ\n        router.patch('/:id/leer');     ‚Üê Ahora va despu√©s ‚úÖ\n        router.post('/system-email');  ‚Üê Nuevo endpoint ‚úÖ\n        router.delete('/');            ‚Üê Nuevo endpoint ‚úÖ\n\n# Archivo 3: notificacion.controller.ts\nCambio: Agregar imports + funciones nuevas\nAgregado: import { sendEmail } from ...\nAgregado: verificarTokenServicio() helper\nAgregado: enviarEmailSistema() funci√≥n\nAgregado: eliminarTodas() funci√≥n\n\n# Archivo 4: email.service.ts\nCambio: Soportar html Y text\nAntes:  interface { html: string }\nAhora:  interface { html?: string, text?: string }\n```\n\n---\n\n## ‚úÖ Estado Final\n\n**Antes:**\n```\n‚ùå GET /api/notificaciones ‚Üí 404 Not Found\n‚ùå Frontend Notifications Menu no funciona\n‚ùå /leer-todas nunca se ejecuta\n‚ùå Falta endpoint para enviar emails\n```\n\n**Despu√©s:**\n```\n‚úÖ GET /api/notificaciones ‚Üí 200 OK\n‚úÖ Frontend Notifications Menu funciona\n‚úÖ PATCH /leer-todas ejecuta correctamente\n‚úÖ POST /system-email disponible\n‚úÖ Todos los endpoints funcionan\n```\n\n