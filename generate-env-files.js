#!/usr/bin/env node

/**
 * Script para generar SERVICE_TOKEN y crear archivos .env
 * Uso: node generate-env-files.js
 */

const crypto = require('crypto');
const fs = require('fs');
const path = require('path');

// Generar SERVICE_TOKEN seguro
const SERVICE_TOKEN = crypto.randomBytes(32).toString('hex');

console.log('üîë SERVICE_TOKEN generado:');
console.log(`   ${SERVICE_TOKEN}`);
console.log('');

// Configuraci√≥n base para cada servicio
const services = {
  'usuarios-svc': {
    port: 3001,
    mongodb: 'mongodb://localhost:27017/aurontek',
    extraVars: `
# JWT
JWT_SECRET=your-super-secret-jwt-key-change-in-production

# Frontend URL (for CORS)
FRONTEND_URL=http://localhost:5173

# reCAPTCHA
RECAPTCHA_SECRET_KEY=your-recaptcha-secret-key

# Cloudinary
CLOUDINARY_CLOUD_NAME=your-cloud-name
CLOUDINARY_API_KEY=your-api-key
CLOUDINARY_API_SECRET=your-api-secret

# Email
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USER=your-email@gmail.com
EMAIL_PASS=your-app-password
`
  },
  'tickets-svc': {
    port: 3002,
    mongodb: 'mongodb://localhost:27017/aurontek_tickets',
    extraVars: `
# URLs de otros servicios
USUARIOS_SERVICE_URL=http://localhost:3001
`
  },
  'gateway-svc': {
    port: 3000,
    mongodb: null,
    extraVars: `
# URLs de microservicios
USUARIOS_SERVICE_URL=http://localhost:3001
TICKETS_SERVICE_URL=http://localhost:3002
CHAT_SERVICE_URL=http://localhost:3003
NOTIFICACIONES_SERVICE_URL=http://localhost:3004
IA_SERVICE_URL=http://localhost:3005
`
  },
  'notificaciones-svc': {
    port: 3004,
    mongodb: 'mongodb://localhost:27017/aurontek_notificaciones',
    extraVars: ''
  },
  'chat-svc': {
    port: 3003,
    mongodb: 'mongodb://localhost:27017/aurontek_chat',
    extraVars: `
# URLs de otros servicios
USUARIOS_SERVICE_URL=http://localhost:3001
`
  }
};

// Crear archivos .env para cada servicio
Object.entries(services).forEach(([serviceName, config]) => {
  const envPath = path.join(__dirname, 'backend', serviceName, '.env');
  
  let envContent = `# Auto-generated by generate-env-files.js
# Generated: ${new Date().toISOString()}

`;

  // MongoDB
  if (config.mongodb) {
    envContent += `# MongoDB\nMONGODB_URI=${config.mongodb}\n\n`;
  }

  // Redis
  envContent += `# Redis\nREDIS_URL=redis://localhost:6379\n\n`;

  // RabbitMQ
  envContent += `# RabbitMQ\nRABBITMQ_URL=amqp://localhost:5672\n\n`;

  // Service Token
  envContent += `# Service Authentication (Inter-service communication)\nSERVICE_TOKEN=${SERVICE_TOKEN}\n`;

  // Extra vars
  if (config.extraVars) {
    envContent += config.extraVars;
  }

  // Port
  envContent += `\n# Server Port\nPORT=${config.port}\n`;

  // Escribir archivo
  try {
    fs.writeFileSync(envPath, envContent);
    console.log(`‚úÖ Creado: ${envPath}`);
  } catch (error) {
    console.error(`‚ùå Error creando ${envPath}:`, error.message);
  }
});

// Crear .env para ia-svc (Python)
const iaEnvPath = path.join(__dirname, 'backend', 'ia-svc', '.env');
const iaEnvContent = `# Auto-generated by generate-env-files.js
# Generated: ${new Date().toISOString()}

# Service Authentication
SERVICE_TOKEN=${SERVICE_TOKEN}

# URLs de otros servicios
USUARIOS_SERVICE_URL=http://localhost:3001
TICKETS_SERVICE_URL=http://localhost:3002

# RabbitMQ
RABBITMQ_URL=amqp://localhost:5672

# Puerto
IA_PORT=3005

# Environment
NODE_ENV=development
`;

try {
  fs.writeFileSync(iaEnvPath, iaEnvContent);
  console.log(`‚úÖ Creado: ${iaEnvPath}`);
} catch (error) {
  console.error(`‚ùå Error creando ${iaEnvPath}:`, error.message);
}

console.log('');
console.log('‚ú® Archivos .env creados exitosamente!');
console.log('');
console.log('üìù IMPORTANTE:');
console.log('   1. Revisa cada archivo .env y ajusta las credenciales');
console.log('   2. Nunca commitees los archivos .env (ya est√°n en .gitignore)');
console.log('   3. Guarda el SERVICE_TOKEN en un lugar seguro');
console.log('');
console.log('üöÄ Para usar en producci√≥n:');
console.log(`   export SERVICE_TOKEN="${SERVICE_TOKEN}"`);
